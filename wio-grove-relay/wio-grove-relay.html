<script type="text/javascript">
	RED.nodes.registerType('wio-grove-relay', {
		paletteLabel: 'relay',
		category: 'wio',
		color: '#C0EDC0',
		defaults: {
			name: { value: '' },
			connection: { value: '', type: 'wio-config' },
			node: { value: '' },
			port: { value: '' },
			logic: { value: 'auto' }
		},
		inputs: 1,
		outputs: 1,
		icon: 'file.png',
		label: function () {
			return this.name || 'relay';
		},
		oneditprepare: function () {
			var config = this;
			config.connection = null;

			var connection = $('#node-input-connection');
			var nodes = $('#node-input-node');
			var ports = $('#node-input-port');

			connection.on('change', function () {
				getConnection();
			});

			nodes.on('change', function () {
				reloadPortSelect();
			});

			function getConnection() {
				$.getJSON('wio-config/config-node?id=' + connection.val()).done(function (res) {
					config.connection = res;
					reloadNodeSelect();
				});
			}

			function reloadNodeSelect() {
				if ((config.connection) && (config.connection.server) && (config.connection.token)) {
					$.ajax({
						url: 'https://' + config.connection.server + '/v1/nodes/list?access_token=' + config.connection.token,
						method: 'GET',
						success: function (res) {
							nodes.html('');
							res.nodes.sort(function (a, b) {
								return ((a.online) ? -1 : 1);
							});
							for (var i = 0; i < res.nodes.length; i++) {
								nodes.append($('<option></option>')
									.attr('value', res.nodes[i].node_key)
									.text(res.nodes[i].name + ' (' + ((res.nodes[i].online) ? 'up' : 'down') + ')'));
							}
							if ((config.node) && (nodes.find('option[value="' + config.node + '"]').length))
								nodes.val(config.node);
							nodes.trigger('change');
						}
					});
				}
			}

			function reloadPortSelect() {
				if (nodes.val()) {
					$.ajax({
						url: 'https://' + config.connection.server + '/v1/node/config?access_token=' + nodes.val(),
						method: 'GET',
						success: function (res) {
							ports.html('');
							for (var i = 0; i < res.config.connections.length; i++) {
								ports.append($('<option></option>')
									.attr('value', res.config.connections[i].port)
									.attr('data-sku', res.config.connections[i].sku)
									.text(res.config.connections[i].port));
							}
							if ((config.port) && (ports.find('option[value="' + config.port + '"]').length))
								ports.val(config.port);
							ports.trigger('change');
						}
					});
				}
			}
		}
	});
</script>

<script type="text/x-red" data-template-name="wio-grove-relay">
	<div class="form-row">
		<label for="node-input-name"><i class="icon-tag"></i> Name</label>
		<input type="text" id="node-input-name" placeholder="Name">
	</div>
	<div class="form-row">
		<label for="node-input-connection"><i class="icon-tag"></i> Connection</label>
		<select type="text" id="node-input-connection"></select>
	</div>
	<div class="form-row">
		<label for="node-input-node"><i class="icon-tag"></i> Node</label>
		<select type="text" id="node-input-node"></select>
	</div>
	<div class="form-row">
		<label for="node-input-port"><i class="icon-tag"></i> Port</label>
		<select type="text" id="node-input-port"></select>
	</div>
	<div class="form-row">
		<label for="node-input-logic"><i class="icon-tag"></i> Logic</label>
		<select type="text" id="node-input-logic">
			<option value="auto">Auto</option>
			<option value="on">On</option>
			<option value="off">Off</option>
		</select>
	</div>
</script>

<script type="text/x-red" data-help-name="wio-grove-relay">
	<p>Wio Grove Relay</p>
</script>